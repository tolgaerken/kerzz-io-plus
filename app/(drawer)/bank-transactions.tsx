import { useFocusEffect } from '@react-navigation/native';
import { useLocalSearchParams } from 'expo-router';
import React, { useCallback, useEffect, useRef, useState } from 'react';
import {
  ActivityIndicator,
  FlatList,
  RefreshControl,
  StyleSheet,
  Text,
  View
} from 'react-native';
import Toast from 'react-native-toast-message';
import {
  BankFilters,
  BankSummaryCard,
  BankTransactionCard
} from '../../components/bank';
import { ThemedText } from '../../components/themed-text';
import { ThemedView } from '../../components/themed-view';
import { useBankTransactionsQuery } from '../../modules/data-layer/hooks';
import { useStyles } from '../../modules/theme';
import {
  bankIntegrationService,
  useBankStore
} from '../../services/bankIntegrationService';
import {
  BankTransactionFilters,
  TBankTransactions,
  TErpStatus
} from '../../types/bank.types';

export default function BankTransactionsScreen() {
  const { colors, spacing, fontSize } = useStyles();
  const [refreshing, setRefreshing] = useState(false);
  const { scrollToTransactionId, timestamp } = useLocalSearchParams();
  const flatListRef = useRef<FlatList>(null);

  // Data-layer hooks
  const bankQuery = useBankTransactionsQuery();
  
  // Zustand store (sadece UI state i√ßin)
  const { filters, setFilters } = useBankStore();

  // React Query hooks
  const { 
    data: transactions = [], 
    isLoading, 
    isError, 
    error,
    refetch 
  } = bankQuery.useTransactionsList(filters, {
    enabled: true,
  });

  const { 
    data: bankAccounts = []
  } = bankQuery.useBankAccounts();

  const updateStatusMutation = bankQuery.useUpdateTransactionStatus();

  // Initialize default filters on screen focus
  useFocusEffect(
    useCallback(() => {
      // Set default filters if not already set
      if (!filters.dateRange?.startDate && !filters.dateRange?.endDate) {
        const defaultDateRange = bankIntegrationService.getDefaultDateRange();
        setFilters({
          ...filters,
          dateRange: defaultDateRange,
          transactionType: 'all'
        });
      }
      return () => {
        // Cleanup if needed
      };
    }, [filters, setFilters])
  );

  // Scroll to specific transaction when data is loaded and scrollToTransactionId is provided
  const scrollToTransaction = useCallback((transactionId: string) => {
    if (!transactionId || transactions.length === 0 || isLoading) {
      return;
    }

    const targetIndex = transactions.findIndex(
      transaction => transaction.id === transactionId
    );
    
    if (targetIndex !== -1) {
      console.log('üéØ ƒ∞lgili transaction bulundu, scroll yapƒ±lƒ±yor:', {
        targetIndex,
        transactionId,
        foundTransaction: transactions[targetIndex]
      });
      
      // Kƒ±sa bir delay ile scroll yap (UI'ƒ±n render olmasƒ± i√ßin)
      setTimeout(() => {
        flatListRef.current?.scrollToIndex({
          index: targetIndex,
          animated: true,
          viewPosition: 0.2, // Transaction'ƒ± ekranƒ±n √ºst %20'sinde g√∂ster
        });
        
        // Toast ile bilgilendirme
        Toast.show({
          type: 'info',
          text1: 'ƒ∞≈ülem Bulundu',
          text2: 'ƒ∞lgili banka i≈ülemine y√∂nlendirildiniz',
          visibilityTime: 3000,
        });
      }, 500);
    } else {
      console.log('‚ö†Ô∏è ƒ∞lgili transaction bulunamadƒ±:', {
        transactionId,
        transactionsCount: transactions.length,
        availableIds: transactions.map(t => ({ id: t.id })).slice(0, 5)
      });
      
      // Transaction bulunamadƒ±ysa bilgilendirme
      Toast.show({
        type: 'info',
        text1: 'ƒ∞≈ülem Bulunamadƒ±',
        text2: 'ƒ∞lgili banka i≈ülemi mevcut filtrelerde g√∂r√ºnm√ºyor',
        visibilityTime: 4000,
      });
    }
  }, [transactions, isLoading]);

  // ƒ∞lk y√ºklemede scroll parametresi varsa scroll yap
  useEffect(() => {
    if (scrollToTransactionId && transactions.length > 0 && !isLoading) {
      scrollToTransaction(scrollToTransactionId as string);
    }
  }, [scrollToTransactionId, transactions, isLoading, scrollToTransaction]);

  // Timestamp deƒüi≈ütiƒüinde scroll yap (replace ile gelen yeni parametreler i√ßin)
  useEffect(() => {
    if (timestamp && scrollToTransactionId && transactions.length > 0 && !isLoading) {
      console.log('üîÑ Timestamp deƒüi≈üti, scroll tetikleniyor:', { timestamp, scrollToTransactionId });
      scrollToTransaction(scrollToTransactionId as string);
    }
  }, [timestamp, scrollToTransactionId, transactions, isLoading, scrollToTransaction]);

  // Navigation parametrelerinin deƒüi≈üimini dinle (sayfa zaten a√ßƒ±kken)
  useFocusEffect(
    useCallback(() => {
      // Sayfa focus olduƒüunda scroll parametresi varsa scroll yap
      if (scrollToTransactionId && transactions.length > 0 && !isLoading) {
        console.log('üìç Sayfa focus oldu, scroll parametresi mevcut:', scrollToTransactionId);
        scrollToTransaction(scrollToTransactionId as string);
      }
    }, [scrollToTransactionId, transactions, isLoading, scrollToTransaction])
  );

  const handleRefresh = async () => {
    setRefreshing(true);
    try {
      await refetch();
      Toast.show({
        type: 'success',
        text1: 'Ba≈üarƒ±lƒ±',
        text2: 'Veriler g√ºncellendi',
      });
    } catch {
      Toast.show({
        type: 'error',
        text1: 'Hata',
        text2: 'Veriler g√ºncellenirken hata olu≈ütu',
      });
    } finally {
      setRefreshing(false);
    }
  };

  const handleFiltersChange = (newFilters: BankTransactionFilters) => {
    setFilters(newFilters);
    // React Query otomatik olarak yeni filtrelerle veri √ßekecek
  };

  const handleStatusChange = async (id: string, status: TErpStatus) => {
    try {
      await updateStatusMutation.mutateAsync({ id, status });
      Toast.show({
        type: 'success',
        text1: 'Ba≈üarƒ±lƒ±',
        text2: 'ƒ∞≈ülem durumu g√ºncellendi',
      });
    } catch {
      Toast.show({
        type: 'error',
        text1: 'Hata',
        text2: 'Durum g√ºncellenirken hata olu≈ütu',
      });
    }
  };

  const renderTransactionItem = ({ item }: { item: TBankTransactions }) => (
    <BankTransactionCard
      transaction={item}
      onStatusChange={handleStatusChange}
    />
  );

  const renderHeader = () => (
    <>
      <BankFilters
        filters={filters}
        bankAccounts={bankAccounts}
        onFiltersChange={handleFiltersChange}
        onRefresh={handleRefresh}
      />
      <BankSummaryCard
        transactions={transactions}
        bankAccounts={bankAccounts}
      />
    </>
  );

  const renderEmpty = () => (
    <View style={styles.emptyContainer}>
      <ThemedText style={styles.emptyText}>
        {isLoading ? 'Y√ºkleniyor...' : 'Se√ßilen kriterlere uygun i≈ülem bulunamadƒ±'}
      </ThemedText>
      {!isLoading && (
        <ThemedText style={styles.emptySubText}>
          Farklƒ± filtreler deneyebilir veya tarih aralƒ±ƒüƒ±nƒ± deƒüi≈ütirebilirsiniz
        </ThemedText>
      )}
    </View>
  );

  const renderFooter = () => {
    if (!isLoading) return null;
    return (
      <View style={styles.loadingFooter}>
        <ActivityIndicator size="small" color={colors.primary} />
        <ThemedText style={styles.loadingText}>Y√ºkleniyor...</ThemedText>
      </View>
    );
  };

  const styles = StyleSheet.create({
    container: {
      flex: 1,
      backgroundColor: colors.background,
    },
    emptyContainer: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
      paddingHorizontal: spacing.large,
      paddingVertical: spacing.xlarge,
    },
    emptyText: {
      fontSize: fontSize.large,
      textAlign: 'center',
      color: colors.textLight,
      marginBottom: spacing.small,
    },
    emptySubText: {
      fontSize: fontSize.medium,
      textAlign: 'center',
      color: colors.textLight,
      opacity: 0.7,
    },
    loadingFooter: {
      flexDirection: 'row',
      justifyContent: 'center',
      alignItems: 'center',
      paddingVertical: spacing.medium,
    },
    loadingText: {
      marginLeft: spacing.small,
      color: colors.textLight,
    },
    errorContainer: {
      backgroundColor: colors.error + '20',
      padding: spacing.medium,
      margin: spacing.medium,
      borderRadius: 8,
      borderWidth: 1,
      borderColor: colors.error + '40',
    },
    errorText: {
      color: colors.error,
      fontSize: fontSize.medium,
      textAlign: 'center',
    },
    initialLoadingContainer: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
      backgroundColor: colors.background,
    },
    initialLoadingText: {
      marginTop: spacing.medium,
      fontSize: fontSize.large,
      color: colors.textLight,
    },
  });

  // Show error state
  if (isError) {
    return (
      <ThemedView style={styles.container}>
        <View style={styles.errorContainer}>
          <Text style={styles.errorText}>
            {error instanceof Error ? error.message : 'Bir hata olu≈ütu'}
          </Text>
        </View>
      </ThemedView>
    );
  }

  return (
    <ThemedView style={styles.container}>
      <FlatList
        ref={flatListRef}
        data={transactions}
        renderItem={renderTransactionItem}
        keyExtractor={(item) => item.id}
        ListHeaderComponent={renderHeader}
        ListEmptyComponent={renderEmpty}
        ListFooterComponent={renderFooter}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={handleRefresh}
            colors={[colors.primary]}
            tintColor={colors.primary}
          />
        }
        showsVerticalScrollIndicator={false}
        contentContainerStyle={
          transactions.length === 0 ? { flex: 1 } : undefined
        }
        onScrollToIndexFailed={(info) => {
          console.log('‚ö†Ô∏è ScrollToIndex ba≈üarƒ±sƒ±z:', info);
          // Fallback: En yakƒ±n index'e scroll yap
          const wait = new Promise(resolve => setTimeout(resolve, 500));
          wait.then(() => {
            flatListRef.current?.scrollToIndex({ 
              index: Math.min(info.index, transactions.length - 1), 
              animated: true 
            });
          });
        }}
      />
      <Toast />
    </ThemedView>
  );
}
